# =============================================================================
# Memo 生产环境 Docker Compose 配置
# =============================================================================
# 用途: 内网离线部署，使用预构建的镜像
# 特点:
#   - 使用 image 字段（直接使用加载的镜像）
#   - 移除源码挂载（镜像已包含代码）
#   - 使用 Docker volumes 进行数据持久化
#   - 生产环境优化配置
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Memo 应用服务
  # 包含: API Server + MCP SSE Server + Frontend Static Server
  # ===========================================================================
  memo:
    image: memo-memo:latest
    container_name: memo-app
    ports:
      - "48000:48000"   # API Server (FastAPI)
      - "48001:48001"   # MCP SSE Server (FastMCP)
      - "48002:48002"   # Frontend Static Server
    volumes:
      # 数据持久化 - SQLite 数据库
      - memo-data:/app/data
    environment:
      # 数据库配置
      - MEMO_DB_PATH=/app/data/memo.db
      # Python 配置
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:48000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - memo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # MCP Box 服务
  # 动态 MCP 工具服务器
  # ===========================================================================
  mcp-box:
    image: memo-mcp-box:latest
    container_name: mcp-box
    ports:
      - "47070:47070"   # MCP SSE 服务器
      - "47071:47071"   # HTTP 管理接口
    volumes:
      # 持久化工具配置文件
      - mcp-config:/app/mcp-box/config
      # 持久化日志
      - mcp-logs:/app/mcp-box/logs
    environment:
      # 存储模式 - 使用文件存储
      - STORE_IN_FILE=true

      # Memo API 地址 (容器内网络)
      - MEMO_API_URL=http://memo:48000

      # Python 配置
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

      # E2B 沙箱配置（可选）
      - E2B_JUPYTER_HOST=${E2B_JUPYTER_HOST:-}
      - E2B_JUPYTER_PORT=${E2B_JUPYTER_PORT:-49999}
      - E2B_DEBUG=${E2B_DEBUG:-false}
      - E2B_API_KEY=${E2B_API_KEY:-}

      # 数据库配置（如果不使用文件存储）
      - DB_HOST=${DB_HOST:-}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-mcpbox}
      - DB_USER=${DB_USER:-mcpbox}
      - DB_PASSWORD=${DB_PASSWORD:-}
    restart: unless-stopped
    depends_on:
      memo:
        condition: service_healthy
    networks:
      - memo-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# 数据卷定义
# =============================================================================
volumes:
  # Memo SQLite 数据库持久化
  memo-data:
    driver: local
    name: memo-data

  # MCP Box 工具配置持久化
  mcp-config:
    driver: local
    name: mcp-config

  # MCP Box 日志持久化
  mcp-logs:
    driver: local
    name: mcp-logs

# =============================================================================
# 网络定义
# =============================================================================
networks:
  memo-network:
    driver: bridge
    name: memo-network
