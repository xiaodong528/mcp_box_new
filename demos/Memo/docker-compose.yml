version: '3.8'

services:
  memo:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    image: memo-memo:latest
    platform: linux/amd64
    container_name: memo-app
    ports:
      # 标准端口映射
      - "48000:48000"   # API Server
      - "48001:48001"   # MCP SSE Server
      - "48002:48002"   # Frontend Static Server
    volumes:
      # Persist SQLite database
      - memo-data:/app/data
      # Mount source code for development (实时生效)
      - ./backend:/app/backend
      - ./frontend:/app/frontend
    environment:
      - MEMO_DB_PATH=/app/data/memo.db
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:48000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - memo-network

  mcp-box:
    build:
      context: ../..  # 指向项目根目录
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    image: memo-mcp-box:latest
    platform: linux/amd64
    container_name: mcp-box
    ports:
      - "47070:47070"  # MCP SSE 服务器
      - "47071:47071"  # HTTP 管理接口
    volumes:
      # 持久化工具配置文件
      - mcp-config:/app/mcp-box/config
      # 持久化日志
      - mcp-logs:/app/mcp-box/logs
    environment:
      # 文件存储模式
      - STORE_IN_FILE=true
      # E2B 沙箱配置
      - E2B_JUPYTER_HOST=${E2B_JUPYTER_HOST}
      - E2B_JUPYTER_PORT=${E2B_JUPYTER_PORT:-49999}
      - E2B_DEBUG=${E2B_DEBUG:-false}
      - E2B_API_KEY=${E2B_API_KEY:-}
      # Memo API 地址 (容器内网络)
      - MEMO_API_URL=http://memo:48000
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # 数据库配置
      - DB_HOST=${DB_HOST:-10.19.88.9}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-mcpbox}
      - DB_USER=${DB_USER:-mcpbox}
      - DB_PASSWORD=${DB_PASSWORD:-mcpbox}

    restart: unless-stopped
    depends_on:
      - memo
    networks:
      - memo-network

volumes:
  # Named volume for database persistence
  memo-data:
    driver: local
  # MCP Box configuration persistence
  mcp-config:
    driver: local
  # MCP Box logs persistence
  mcp-logs:
    driver: local

networks:
  memo-network:
    driver: bridge
